<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö–æ—Ä–∑–∏–Ω–∞</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f9f9f9;
        }

        h1 {
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #337ab7;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        #clear-cart-btn {
            margin: 20px;
            padding: 10px 20px;
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        #clear-cart-btn:hover {
            background-color: #c9302c;
        }
        .delete-btn {
            padding: 6px 12px;
            background-color: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .delete-btn:hover {
            background-color: #d32f2f;
        }
        #home-btn {
            margin: 20px;
            padding: 10px 20px;
            background-color: #5bc0de;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }

        #home-btn:hover {
            background-color: #31b0d5;
        }

    </style>
</head>
<body>

<h1>–°–ø–∏—Å–æ–∫ –∑–∞–∫–∞–∑–æ–≤
    <button id="clear-cart-btn">–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É</button>
    <button id="home-btn">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
</h1>

<table>
    <thead>
    <tr>
        <th>–ú–æ–¥–µ–ª—å</th>
        <th>–ö–æ–¥</th>
        <th>–¶–µ–Ω–∞</th>
        <th>Username</th>
        <th>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞</th>
    </tr>
    </thead>
    <tbody id="cart-body">
    </tbody>
</table>

<script>
    const cartBody = document.getElementById("cart-body");
    const token = localStorage.getItem('authToken');

    if (!token) {
        alert("–í—ã –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.");
        window.location.href = "login.html";
    }


    fetch("http://localhost:8080/customer/cart/user",{
        headers: {
            'Authorization': 'Bearer ' + token
        }
    } )
        .then(response => {
            if (!response.ok) {
                throw new Error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã: " + response.status);
            }
            return response.json();
        })
        .then(data => {
            cartBody.innerHTML = "";
            data.forEach(item => {
                const row = document.createElement("tr");

                row.innerHTML = `
                    <td>${item.model}</td>
                    <td>${item.code}</td>
                    <td>${item.price}</td>
                    <td>${item.username}</td>
                    <td>${item.orderId ?? ''}</td>
                    <td><button class="delete-btn" data-orderid="${item.orderId}">–£–¥–∞–ª–∏—Ç—å</button></td>
                `;

                // üëâ –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Ç—Ä–æ–∫–µ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ–≤–∞—Ä–∞
                row.querySelectorAll('td:not(:last-child):not(:nth-child(6))').forEach(cell => {
                    cell.addEventListener('click', () => {
                        let url;
                        switch (item.type) {
                            case 'Laptop':
                                url = `customer-laptop.html?code=${item.code}`;
                                break;
                            case 'Printer':
                                url = `customer-printer.html?code=${item.code}`;
                                break;
                            case 'PC':
                                url = `customer-pc.html?code=${item.code}`;
                                break;
                            default:
                                console.warn("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞:", item.type);
                                return;
                        }
                        window.location.href = url;
                    });
                });

                // üëâ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–£–¥–∞–ª–∏—Ç—å"
                const deleteButton = row.querySelector('.delete-btn');
                deleteButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // —á—Ç–æ–±—ã –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª –ø–µ—Ä–µ—Ö–æ–¥

                    const orderId = deleteButton.getAttribute('data-orderid');

                    if (!orderId) {
                        alert("–û—à–∏–±–∫–∞: orderId –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç");
                        return;
                    }

                    if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?")) {
                        fetch(`http://localhost:8080/customer/cart/${orderId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': 'Bearer ' + token
                            }
                        })
                            .then(response => {
                                if (response.ok) {
                                    console.log('–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω');
                                    location.reload();
                                } else {
                                    return response.text().then(text => {
                                        console.error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:", text);
                                        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞');
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
                            });
                    }
                });

                cartBody.appendChild(row);
            });
        })
        .catch(error => {
            console.error("–û—à–∏–±–∫–∞:", error);
            cartBody.innerHTML = `<tr><td colspan="6">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã</td></tr>`;
        });


    document.getElementById('clear-cart-btn').addEventListener('click', () => {
        if (confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?")) {
            const username = 'customer'; // –µ—Å–ª–∏ —Ö–æ—Ç–∏–º —É–¥–∞–ª–∏—Ç—å, —Ç–æ —Ç—É—Ç –º–µ–Ω—è–µ–º —É –∫–æ–≥–æ

            fetch(`http://localhost:8080/customer/cart/user/${username}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(response => {
                    if (response.ok) {
                        console.log('–ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞');
                        location.reload();
                    } else {
                        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–æ—Ä–∑–∏–Ω—ã');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–æ—Ä–∑–∏–Ω—ã', error);
                });
        }
    });

    document.getElementById('home-btn').addEventListener('click', () => {
        window.location.href = "customer-index.html";
    });
</script>

</body>
</html>